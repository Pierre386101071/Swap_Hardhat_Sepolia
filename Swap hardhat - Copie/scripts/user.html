<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Simple DEX</title>
</head>
<body>
  <h1>Swap DApp</h1>

  <button id="connectBtn">Connect Wallet</button>
  <br><br>
  <div id="messageBox" style="color: green; margin-top: 10px;"></div>
  <input type="text" id="tokenFrom" placeholder="Token From Address">
  <input type="text" id="tokenTo" placeholder="Token To Address">
  <input type="text" id="amount" placeholder="Amount">
  <button id="swapBtn">Swap</button>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const CONTRACT_ADDRESS = "0x33a2206f6E37FDeE9b2E386CB6A8694F9AC64778"; 
    const ABI = [
      "function getSwapRate(address,address) view returns(uint256)",
      "function swap(address,address,uint256) external payable",
      "function addToken(address,uint256,string memory) external",
      "function addLiquidity(address,uint256) external payable",
      "function getLiquidity(address) view returns(uint256)",
    ];

    let provider, signer, contract;

    async function connectWallet() {
      if (window.ethereum) {
        try {
          // Forcer l'ouverture de MetaMask
          await ethereum.request({
            method: 'wallet_requestPermissions',
            params: [{ eth_accounts: {} }]
          });

          await ethereum.request({ method: 'eth_requestAccounts' });

          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

          const address = await signer.getAddress();
          alert("Wallet connecté : " + address);
        } catch (err) {
          console.error("Connexion refusée ou erreur :", err);
          alert("Connexion à Metamask refusée ou impossible");
        }
      } else {
        alert("Installe Metamask pour utiliser cette DApp");
      }
    }

    async function swapTokens() {
      const from = document.getElementById("tokenFrom").value;
      const to = document.getElementById("tokenTo").value;
      const amount = document.getElementById("amount").value;

      if (!from || !to || !amount) return alert("Remplis tous les champs");

      try {
        const tx = await contract.swap(from, to, ethers.utils.parseUnits(amount, 18));
        await tx.wait();
        alert("Swap effectué avec succès !");
      } catch (err) {
        console.error("Erreur lors du swap :", err);
        alert("Erreur lors du swap : voir console");
      }
    }

    document.getElementById("connectBtn").addEventListener("click", connectWallet);
    document.getElementById("swapBtn").addEventListener("click", swapTokens);
  </script>
</body>
</html>